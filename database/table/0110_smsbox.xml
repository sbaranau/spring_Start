<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd"
  logicalFilePath="table/0110_smsbox.xml">

    <changeSet id="0.0.1_0110" author="Aleksandr Golovnyov">
        <comment>Creates table "smsbox"</comment>
        <createTable tableName="smsbox" schemaName="${db.schema}">
            <column name="id" type="bigint" remarks="id" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_smsbox" nullable="false"/>
            </column>
            <column name="recipient" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="text" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="integer">
                <constraints nullable="false"
                    foreignKeyName="fk_status" references="${db.schema}.sms_status (id)"/>
            </column>
            <column name="status_change_date" type="timestamp with time zone" 
                remarks="Дата изменения статуса">
                <constraints nullable="false" />
            </column>
            <column name="error" type="varchar" remarks="Сообщение об ошибке"/>
        </createTable>
        <sql>
            ALTER TABLE ${db.schema}.smsbox
                ADD CONSTRAINT ck_recipient CHECK (length(btrim(recipient::text)) > 0),
                ADD CONSTRAINT cK_text CHECK (length(btrim(text::text)) > 0),
                ADD CONSTRAINT ck_error CHECK (length(btrim(error::text)) > 0);
        </sql>
        <rollback>
            <dropTable tableName="smsbox" schemaName="${db.schema}"/>
        </rollback>
    </changeSet>

</databaseChangeLog>


